@page "/products/import"
@inject IProductsClient ProductsClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<AppPageTitle>Import Products</AppPageTitle>

<MudText Typo="Typo.h3" Align="Align.Center" Class="mb-12" GutterBottom="true">Import Products</MudText>

<MudText Typo="Typo.body1">Upload a Zip file containing a products.csv file and multiple image files.</MudText>

<MudFileUpload T="IReadOnlyList<IBrowserFile>" Accept=".zip" OnFilesChanged="UploadArchive" Hidden="false" Class="flex-1" InputClass="absolute mud-width-full mud-height-full overflow-hidden z-20" InputStyle="opacity:0"
                   @ondragenter="@SetDragClass" @ondragleave="@ClearDragClass" @ondragend="@ClearDragClass">
    <ButtonTemplate>       
        <MudPaper Height="300px" Outlined="true" Class="@DragClass">
            <MudText Typo="Typo.h6">Zip file</MudText>
            <MudText Typo="Typo.body1">@(archiveFile is null ? "Drag and drop files here or click" : archiveFile.Name)</MudText>
        </MudPaper>
    </ButtonTemplate>
</MudFileUpload>

<MudButton OnClick="Upload" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Filled.CloudUpload" Class="mt-4" Disabled="@(!CanUpload)">
    Upload
</MudButton>

@code 
{
    private static string DefaultDragClass = "relative rounded-lg border-2 border-dashed pa-4 mt-4 mud-width-full mud-height-full z-10";
    private string DragClass = DefaultDragClass;

    IBrowserFile archiveFile;

    private async void UploadArchive(InputFileChangeEventArgs e)
    {
        archiveFile = e.GetMultipleFiles().First();
    }

    public bool CanUpload => (archiveFile is not null);

    private async void Upload()
    {
        try 
        {
            await ProductsClient.ImportProductsAsync(new FileParameter(archiveFile.OpenReadStream(3 *
                1000000), archiveFile.Name));

            Snackbar.Add("Import successful", Severity.Success);
        }
        catch(Exception) 
        {
            Snackbar.Add("Import failed", Severity.Error);
        }
    }

    private void SetDragClass()
    {
        DragClass = $"{DefaultDragClass} mud-border-primary";
    }

    private void ClearDragClass()
    {
        DragClass = DefaultDragClass;
    }
}