@using Navigation
@inject YourBrand.Portal.Services.ICurrentUserService CurrentUserService

<MudNavGroup Title="@NavGroup.Name" Icon="@NavGroup.Icon" Expanded="NavGroup.Expanded" ExpandedChanged="(v) => SaveCallback(v, NavGroup)">
    @foreach (var navItem in NavGroup.Items)
    {
            if (navItem.RequiresAuthorization)
            {
                if (navItem.Roles is null || IsInAnyRole(navItem.Roles))
                {
                    if (navItem.Visible)
                    {
                        <AuthorizeView Roles="@(navItem.Roles == null ? null : string.Join(",", navItem.Roles))">
                            @if(navItem is NavItem navItem1) 
                            {
                                <MudNavLink Icon="@navItem1.Icon" Href="@navItem1.Href">@navItem.Name</MudNavLink>
                                
                            }
                            else if(navItem is NavGroup navGroup) 
                            {
                                <NavGroupView NavGroup="navGroup" SaveCallback="SaveCallback" />
                            }               
                        </AuthorizeView>
                    }
                }
            }
            else
            {
                if (navItem.Visible)
                {
                    if(navItem is NavItem navItem1) 
                    {
                        <MudNavLink Icon="@navItem1.Icon" Href="@navItem1.Href">@navItem.Name</MudNavLink>
                    }
                    else if(navItem is NavGroup navGroup) 
                    {
                        <NavGroupView NavGroup="navGroup" SaveCallback="SaveCallback" />
                    }
                }
            }
    }
</MudNavGroup>

@code {
    IEnumerable<string>? roles;

    protected override async Task OnInitializedAsync()
    {
        roles = await CurrentUserService.GetRoles();
    }

    [Parameter] public NavGroup NavGroup { get; set; }

    [Parameter] public Func<bool, NavGroup, bool> SaveCallback { get; set; }

    private bool IsInAnyRole(IEnumerable<string> desiredRoles)
    {
        foreach(var desiredRole in desiredRoles)
        {
            bool isInRole = roles.Any(r => r == desiredRole);
            if (isInRole) return true;
        }

        return false;
    }
}